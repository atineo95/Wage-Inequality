---
title: "Wage Inequality Analysis"
output: word_document
date: "2025-04-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r cars}
filepath1 <- "C:/Users/tineo/OneDrive/Desktop/R/oesm23st/state_M2023_dl.xlsx"
wagesRaw <- readxl::read_excel(filepath) %>% 
  clean_names()

filepath2 <- "C:/Users/tineo/OneDrive/Desktop/R/oesm23nat/national_M2023_dl.xlsx"
wagesNationalRaw <- readxl::read_excel(filepath2) %>% 
  clean_names()
```


```{r}
#count how many missing values are there
wagesRaw %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(cols = everything(),
               names_to = "variable",
               values_to = "missing_count") %>%
  arrange(desc(missing_count))


#turn mean and median into numeric from character and remove NAs for these two metrics
wagesCleaned <- wagesRaw %>%
  mutate(
    a_mean = as.numeric(a_mean),
    a_median = as.numeric(a_median),
    tot_emp = as.numeric(gsub(",", "", tot_emp))
  ) %>%
  filter(!is.na(a_mean), !is.na(a_median)) %>%
 # filter(o_group == 'detailed') %>%
  filter(!area_title %in% c('Guam', 'Puerto Rico', 'Virgin Islands'))

#when we need to only look at just state vs state
allOccupations <- wagesCleaned %>%
  filter(occ_title == 'All Occupations')

```
#THESE NEXT SECTIONS WILL BE FOR EDA

#Map of USA with average wage for each state
```{r}
#US Map that plots the average weight for all states
plot_usmap(data = allOccupations, values = "a_mean", include = c(state.abb, "DC")) +
  scale_fill_gradient(
    low = "#E6F4EA",
    high = "#007600",
    name = "Average Mean Wage",
    labels = scales::dollar_format()
  ) +
  labs(
    title = "Average Mean Wage by State (Including D.C.)"
  ) +
  theme_minimal(base_size = 10) +
  theme(
    plot.title = element_text(hjust = 0, face = "bold", size = 11),
    legend.title = element_text(face = "bold")
  )

```

#top 5 and bottom 5 states by salary
```{r}
getTopAndBottomStatesData <- function(data, n = 5) {
  rankedStates <- data %>%
    arrange(desc(a_mean))

  topStates <- head(rankedStates$area_title, n)
  bottomStates <- tail(rankedStates$area_title, n)

  selectedStates <- c(topStates, bottomStates)

  # Now filter the full data to keep all rows for these states
  filteredData <- data %>%
    filter(area_title %in% selectedStates)
}

wagesTopAndBottom <- getTopAndBottomStates(allOccupations, n = 5)

#boxplot of the distribution of wages per state - 
ggplot(wagesTopAndBottom, aes(x = reorder(area_title, a_median), y = a_median)) +
  geom_col(fill = "#006400") +
  coord_flip() +
  labs(
    title = "Top and Bottom States by Average Wage",
    x = "State",
    y = "Annual Mean Wage ($)"
  ) +
  scale_y_continuous(labels = scales::dollar_format()) +
  theme_minimal(base_size = 10) +
  theme(
    plot.title = element_text(hjust = 0, face = "bold", size = 11),
    legend.title = element_text(face = "bold", size = 8)
  )

```

#Common or Rare Jobs
```{r}
#most common or rarest jobs across the dataset
getCommonOrRareJobs <- function(dataset, top = TRUE, n = 10) {
  dataset %>%
    group_by(occ_title) %>%
    summarise(totalEmp = sum(tot_emp, na.rm = TRUE)) %>%
    filter(occ_title != "All Occupations") %>%
    {
      if (top) {
        arrange(., desc(totalEmp)) %>%
          slice(1:n)
      } else {
        arrange(., totalEmp) %>%
          slice(1:n)
      }
    }
}

commonJobs <- getCommonOrRareJobs(wagesCleaned, top = TRUE, n = 10)
rareJobs <- getCommonOrRareJobs(wagesCleaned, top = FALSE, n = 10)

commonJobs$occ_title <- str_wrap(commonJobs$occ_title, width = 30)

#Barplot of common and rare jobs
ggplot(commonJobs, aes(x = reorder(occ_title, totalEmp), y = totalEmp)) +
  geom_col(fill = "#006400") +  # Navy blue
  coord_flip() +
  labs(
    title = "Top 10 Most Common Occupations in the U.S.",
    x = "Occupation",
    y = "Total Employment"
  ) +
  scale_y_continuous(labels = scales::comma_format()) +
  theme_minimal(base_size = 10) +
  theme(
    plot.title = element_text(hjust = 0, face = "bold", size = 11),
    axis.title.x = element_text(size = 8),
    axis.title.y = element_text(size = 8)
  )
```

#THIS IS USING NATIONAL 
```{r}
topPayingJobs <- wagesCleaned %>%
  filter(!occ_title %in% c("All Occupations")) %>%
  filter(!occ_code == '11-1011') %>% #CEO Duplicate
  filter(!occ_code == '29-1151') %>% #nurse duplicate
  arrange(desc(a_mean)) %>%
  slice(1:10)

WorstPayingJobs <- wagesCleaned %>%
  filter(!occ_title %in% c("All Occupations")) %>%
  filter(!occ_code == '35-3023') %>% #Fast food duplicate
  filter(!occ_code == '39-3031') %>% #user
  filter(!occ_code == '35-9031') %>% #Host
  filter(!occ_code == '41-2010') %>% #Cashiers
  arrange(a_mean) %>%
  slice(1:10)

WorstPayingJobs$occ_title <- str_wrap(WorstPayingJobs$occ_title, width = 30)

#bar blot for paying jobs
ggplot(WorstPayingJobs, aes(x = reorder(occ_title, a_mean), y = a_mean)) +
  geom_col(fill = "#000080") +  # Navy blue
  coord_flip() +
  labs(
    title = "Worst 10 Paid Occupations on Average in the U.S.",
    x = "Occupation",
    y = "Average Wage"
  ) +
  scale_y_continuous(labels = scales::comma_format()) +
  theme_minimal(base_size = 10) +
  theme(
    plot.title = element_text(hjust = 0, face = "bold", size = 11),
    axis.title.x = element_text(size = 8),
    axis.title.y = element_text(size = 8)
  )

topPayingTitles <- topPayingJobs$occ_title %>% unique() %>% as.character()
topPayingTitles <- stringr::str_trim(topPayingTitles)

worstPayingTitles <- WorstPayingJobs$occ_title %>% unique() %>% as.character()
worstPayingTitles <- stringr::str_trim(worstPayingTitles)

```

#See if best/worst paying jobs are proportionally over/under-represented in high/low-wage states
```{r}
calculateJobConcentration <- function(jobTitles, dataset, statesOfInterest, wrapWidth = 30) {
  
  dataset %>%
    filter(o_group == "detailed", occ_title %in% jobTitles) %>%
    {
      selectedJobs <- .
      
      nationalJobTotals <- selectedJobs %>%
        group_by(occ_title) %>%
        summarise(nationalEmp = sum(tot_emp, na.rm = TRUE)) %>%
        ungroup()
      
      StatesJobTotals <- selectedJobs %>%
        filter(area_title %in% statesOfInterest) %>%
        group_by(occ_title) %>%
        summarise(StateEmp = sum(tot_emp, na.rm = TRUE)) %>%
        ungroup()
      
      left_join(StatesJobTotals, nationalJobTotals, by = "occ_title") %>%
        mutate(
          percentInStates = round(100 * StateEmp / nationalEmp, 1),
          occ_title = str_wrap(occ_title, width = wrapWidth)
        )
    }
}


topJobConcentration <- calculateJobConcentration(
  jobTitles = topPayingTitles,
  dataset = wagesCleaned,
  statesOfInterest = c("Mississippi", "West Virginia", "Arkansas")
)

worstJobConcentration <- calculateJobConcentration(
  jobTitles = worstPayingTitles,
  dataset = wagesCleaned,
  statesOfInterest = c("Mississippi", "West Virginia", "Arkansas")
)

worstJobConcentration$occ_title <- str_wrap(worstJobConcentration$occ_title, width = 30)

ggplot(topJobConcentration, aes(x = reorder(occ_title, percentInStates), y = percentInStates)) +
  geom_col(fill = "#006400") +
  geom_text(
    aes(label = paste0(round(percentInStates), "%")),
    hjust = -0.4,
    size = 2.8,
    fontface = "bold"
  ) +
  coord_flip() +
  labs(
    title = "Share of U.S. Employment in Low-Paying Jobs in CA, NY, or D.C.",
    x = "Occupation",
    y = "Percent of National Employment"
  ) +
  scale_y_continuous(
    labels = function(x) paste0(round(x), "%"),
    limits = c(0, max(worstJobConcentration$percentInStates) + 5)
  ) +
  theme_minimal(base_size = 9) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0),
    axis.title.x = element_text(face = "bold"),
    axis.title.y = element_text(face = "bold")
  )

wagesCleaned %>%
  filter(occ_title == 'Chief Executives')

```

#Difference between Mean and Median by State
```{r}
plotWageGapByState <- function(data, n = 10, barColor = "#006400") {
  # Step 1: Calculate mean-median gap for each state
  meanMedianDiff <- data %>%
    filter(occ_title == "All Occupations") %>%
    mutate(meanMedianGap = a_mean - a_median) %>%
    select(area_title, meanMedianGap)

  # Step 2: Get top and bottom N states
  wageGapStates <- meanMedianDiff %>%
    filter(!is.na(meanMedianGap)) %>%
    slice_max(meanMedianGap, n = n) %>%
    bind_rows(
      meanMedianDiff %>%
        slice_min(meanMedianGap, n = n)
    )

  # Step 3: Plot
  ggplot(wageGapStates, aes(x = reorder(area_title, meanMedianGap), y = meanMedianGap)) +
  geom_col(fill = barColor) +
  coord_flip() +
  scale_y_continuous(
    labels = scales::dollar_format(),
    limits = c(0, 25000)  # ‚Üê this guarantees your axis reaches at least $30k
  ) +
  labs(
    title = "States with the Largest and Smallest Gaps Between Mean and Median Wages",
    x = "State",
    y = "Mean - Median Wage ($)"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0),
    plot.title.position = "plot",
    axis.title.x = element_text(face = "bold", size = 8),
    axis.title.y = element_text(face = "bold", size = 8)
  )

}

plotWageGapByState(wagesCleaned, n = 5, barColor = "#006400")
```

#work to find 





```{r}

ggplot(wagesCleaned, aes(x = a_mean)) +
  geom_histogram(fill = "steelblue", bins = 30) +
  labs(title = "Distribution of Average Wages", x = "Annual Mean Wage", y = "Count")


ggplot(wagesCleaned, aes(x = tot_emp)) +
  geom_histogram(fill = "purple", bins = 30) +
  labs(title = "Distribution of Total Employment", x = "Number of Employees", y = "Count") +
  scale_x_log10()


wagesCleaned <- wagesCleaned %>%
  filter(a_mean > 0) %>%
  mutate(log_wage = log(a_mean))

ggplot(wagesCleaned, aes(x = log_wage)) +
  geom_histogram(bins = 30, fill = "darkgreen", color = "white", alpha = 0.8) +
  labs(
    title = "Distribution of Log-Transformed Average Wages",
    x = "Log(Average Annual Wage)",
    y = "Count"
  ) +
  theme_minimal()

```


